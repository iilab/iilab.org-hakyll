<!doctype html>
<html lang="en-US">
    <head>
                <!-- Meta -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta name="description" content>
        <meta name="author" content>

        <title>iilab | Nix + OSX + HaskellNG = ?</title>

        <!-- Bootstrap Core CSS 
        <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
        
        <!-- Customizable CSS 
        <link href="/assets/css/main.css" rel="stylesheet" data-skrollr-stylesheet>
        <link href="/assets/css/iilab.css" rel="stylesheet" title="iilab colors">
        <link href="/assets/css/gray.css" rel="stylesheet" title="Gray color">
        <link href="/assets/css/owl.carousel.css" rel="stylesheet">
        <link href="/assets/css/owl.transitions.css" rel="stylesheet">
        <link href="/assets/css/animate.min.css" rel="stylesheet"> -->
                
        <!-- Icons/Glyphs 
        <link href="/assets/fonts/fontello.css" rel="stylesheet"> -->

        <link href="css/style.css" rel="stylesheet">
        
        <!-- Favicon -->
        <link rel="shortcut icon" href="../images/favicon.ico">


        <!-- HTML5 elements and media queries Support for IE8 : HTML5 shim and Respond.js -->
        <!--[if lt IE 9]>
                <script src="/js/html5shiv.js"></script>
                <script src="/js/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        		<header>
			<div class="navbar">
				<div class="navbar-header">
					<div class="container">
						<ul class="info pull-left">
							<li><a href="mailto:contact@iilab.org"><i class="icon-mail-1 contact"></i> contact@iilab.org </a></li>
						</ul>
						<ul class="social pull-right">
							<li><a href="http://www.facebook.com/iilab.org"><i class="icon-s-facebook"></i></a></li>
							<li><a href="https://plus.google.com/b/106011859086478758954/106011859086478758954"><i class="icon-s-gplus"></i></a></li>
							<li><a href="http://twitter.com/iilab"><i class="icon-s-twitter"></i></a></li>
							<li><a href="https://github.com/iilab"><i class="icon-s-github"></i></a></li>
							<li><a href="http://www.linkedin.com/company/iilab"><i class="icon-s-linkedin"></i></a></li>
						</ul>
						<a class="navbar-brand" href="index.html"><img src="../images/logo.svg" class="logo" alt></a>
						<a class="btn responsive-menu pull-right" data-toggle="collapse" data-target=".navbar-collapse"><i class="icon-menu-1"></i></a>
					</div>
				</div>
				<div class="yamm">
					<div class="navbar-collapse collapse">
						<div class="container">
							<a class="navbar-brand" href="../index.html"><img src="../images/logo.svg" class="logo" alt></a>
							<ul class="nav navbar-nav pull-right">
								<li class="dropdown">
									<a href="../" class>Home</a>
								</li>
								<li class="dropdown">
									<a href="../#about" class>About</a>
								</li>
								<li class="dropdown">
									<a href="../#work" class>Work</a>
								</li>
								<li class="dropdown">
									<a href="../#team" class>Team</a>
								</li>
								<li class="dropdown">
									<a href="../news.html" class>News</a>
								</li>
								<!-- <li class="dropdown pull-right searchbox">
									<a href="#" class="dropdown-toggle js-activated"><i class="icon-search"></i></a>
									<div class="dropdown-menu">
										<form id="search" class="navbar-form search" role="search">
											<input type="search" class="form-control" placeholder="Type to search">
											<button type="submit" class="btn btn-default btn-submit icon-right-open"></button>
										</form>
									</div>
								</li>/.searchbox -->
							</ul><!-- /.nav -->
						</div><!-- /.container -->
					</div><!-- /.navbar-collapse -->
				</div><!-- /.yamm -->
			</div><!-- /.navbar -->
		</header>

    <main>
      <section id="blog-post" class="light-bg">
        <div class="container inner-bottom classic-blog">
          <div class="row">
            
            <div class="col-md-12 inner-sm">
                
              <div class="sidemeta">
              <p>I’ve recently started to look into learning Haskell and have been in the books for a few months, so didn’t yet have to experience the practical side of what comes with the workflow of working with Haskell. That basically mean I didn’t know what “cabal hell” was. Last year after a difficult experience with Jekyll for the Amnesty International Panic Button website, I looked around other approaches to do static website generation and, given I was into JS at the time and like the small modules approach, I settled on metalsmith, which seemed to have a clever design, based on a configurable pipeline, that seemed flexible enough. When I installed it, I did have to hack a few modules to make them do what I wanted, but it seemed straighforward enough. More recently I wanted to do a bit of freshening up on our website, and was looking at building a workflow with css/js concatenation and minimisation. Given how metalsmith was supposed to be this versatile, build pipeline, I thought it would be simple but I got turned off by the lack of clarity, and things started breaking pretty badly when I tried to upgrade modules to latest versions.</p>
<!--more-->
<p>That’s when, in a familiar sequence of events, <a href="http://chriswarbo.net/blog/2014-07-14-nixos.html">well captured</a> as 1. Try to do something simple 2. Fail 3. Go down a rabbit hole in an attempt to fix it</p>
<p>I recursed through a few rabbit holes after my metalsmith/npm woes by trying Hakyll, running into cabal hell, decided to try Nix, saw that it was a bit bleeding edge for OSX, managed to go through that more or less, until I bumped into a compilation problem with the haskellPackages and was helped by the nice folks on the ##nix-darwin IRC channel and pointed to the even more bleeding edge HaskellNG Nix approach which of course, is how deep the rabbit hole goes.</p>
<h2 id="nix">Nix</h2>
<p>Nix is a package manager which is also the foundation of a linux distribution called NixOS which uses the philosophy of Nix through and through to provide a well regarded linux distribution. What Nix offers is a reliable way to manage dependencies and escape the various type of hells that the problem creates (DLL hell, cabal hell, the type of spagetthi that systems folk don’t want…). It does this by knowing the complete dependency tree of all the packages it manages. This reminds me of docker’s declarative approach to system configuratio, except that I think that docker’s layered approach at the file system level brings an interesting lower level dimension. In any case, with Nix, several binaries with a different set of dependencies can coexist on your system, and more importantly, use the functional immutable approach to Nix package dependencies in order to keep your environment and yourself health, sane and functional.</p>
<p>A few things that Nix does is make sure dependencies are exact (by using binary hashes in a clever way - which includes all the dependency tree of the binary) and only reuse them when necessary. This means that the nix store holds a range of binary images which might be used by different other binaries and can coexist happily.</p>
<p>Nix then offers a number of wrapping tools to make these binaries available, for instance, when installing with <code>nix-env -iA nixpkgs.somePackage</code> you’re installing somePackage inside your <strong>user environment</strong> which is in fact symbolic links to the nix store defined in your <code>~/.nix-profile</code> directory.</p>
<p>When using <code>nix-shell</code> you’re using a <strong>project environment</strong> which might have different dependencies.</p>
<h2 id="nix-on-osx">Nix on OSX</h2>
<p>The great thing, given my current dependency on this fruity old laptop and its pretty UX, is that Nix is available on OSX. I took me a little bit of meandering to find out because there are <a href="http://www.chrisjr.org/posts/2014/12/22/nix-osx-haskell/">outdated blog posts</a> on the web (which give workarounds from <strong>before</strong> the OSX changes were marged into the Nix master branch) that <a href="https://nixos.org/wiki/Nix_on_OS_X#Using_Nix_on_10.9_and_10.10">these instructions on the NixOS Wiki about <strong>Using Nix on 10.9 and 10.10</strong></a> actually work just fine. I did bump into a problem because I started installing from the wrong git repo, a number of weird errors came up after switching to the correct instructions which meant that I had to restart from scratch and remove all the nix directories (/nix/store and ˜/.nix-profile).</p>
<h2 id="haskellng-on-nix">HaskellNG on Nix</h2>
<p>When I first bumped into <a href="http://article.gmane.org/gmane.linux.distributions.nixos/15513">this post about the new way</a> to do Haskell with Nix, I thought : “Oh, this looks great but very bleeding edge and I’m down several rabbit holes already so let’s look at it later”. So I went my merry way installing following <a href="https://nixos.org/wiki/Haskell">the official Nix instructions on the wiki</a>. But then after installing the Haskell toolkit (apparently the <a href="https://www.mail-archive.com/nix-dev@lists.science.uu.nl/msg13622.html">Nix crowd is too cool for the Haskell Platform</a>) I found out that the Nix tribe on OSX seemed to have already left the old ways behind and migrated to HaskellNG. I found out because I ran into this error</p>
<pre><code>installing ‘haskell-hakyll-ghc7.8.4-4.6.1.1-shared’
error: Package ‘util-linux-2.26’ in ‘/../dev/nixpkgs/pkgs/os-specific/linux/util-linux/default.nix:54’ is not supported on ‘x86_64-darwin’, refusing to evaluate.</code></pre>
<h2 id="step-by-step">Step by step</h2>
<p>To recap, here’s what it took to set things up: - following <a href="https://nixos.org/wiki/Nix_on_OS_X#Using_Nix_on_10.9_and_10.10">these steps to install Nix on OSX 10.10</a> - adapting <a href="http://thread.gmane.org/gmane.linux.distributions.nixos/15035/focus=15161">these steps</a> to haskellng - and <a href="http://wiki.ocharles.org.uk/Nix">this description of the haskell cabal workflow</a>.</p>
<h3 id="install-nix-on-osx">Install Nix on OSX</h3>
<p>A <a href="https://nixos.org/wiki/Nix_on_OS_X#Using_Nix_on_10.9_and_10.10">slightly more concise version of the official Nix wiki instructions</a>. ** I’d recommend heading over there for the latest!!! **</p>
<pre><code>$ xcode-select --install
$ sudo xcode-select --switch /Library/Developer/CommandLineTools
$ sudo clang  --version
$ curl https://nixos.org/nix/install | sh
$ . $HOME/.nix-profile/etc/profile.d/nix.sh$ git clone https://github.com/NixOS/nixpkgs.git
$ nix-channel --remove nixpkgs
$ cd ~/.nix-defexpr
$ rm -rf *
$ ln -s /path/of/nixpkgs/clone nixpkgs</code></pre>
<pre><code>$ sudo mkdir /etc/nix</code></pre>
<p>Create a <code>/etc/nix/nix.conf</code> file with</p>
<pre><code>binary-caches = http://cache.nixos.org/ </code></pre>
<p>Update the .bashrc</p>
<pre><code>export NIX_PATH=/Users/jun/dev/nixpkgs:nixpkgs=/Users/jun/dev/nixpkgs
export NIX_GHC_VERSION=$(ghc --numeric-version)
export NIX_GHC=&quot;$HOME/.nix-profile/bin/ghc&quot;
export NIX_GHCPKG=&quot;$HOME/.nix-profile/bin/ghc-pkg&quot;
export NIX_GHC_DOCDIR=&quot;$HOME/.nix-profile/share/doc/ghc/html&quot;
export NIX_GHC_LIBDIR=&quot;$HOME/.nix-profile/lib/ghc-${NIX_GHC_VERSION}&quot;</code></pre>
<p>Source this</p>
<pre><code>$ source ~/.bashrc</code></pre>
<h2 id="configure-nix-for-haskell">Configure Nix for Haskell</h2>
<p>Create a ~/.nixpkgs director</p>
<p>Create a <code>~/.nixpkgs/config.nix</code> file which will be read each time you use nix</p>
<pre><code>{
  packageOverrides = super: let self = super.pkgs; in
  {
    haskellEnv = self.haskellngPackages.ghcWithPackages (p: with p; [
      async attoparsec case-insensitive fgl GLUT GLURaw haskell-src
      hashable html HTTP HUnit mtl network OpenGL OpenGLRaw parallel
      parsec QuickCheck random regex-base regex-compat regex-posix split stm
      syb text transformers unordered-containers vector /*xhtml*/ zlib      
      # tools
      cabal-install
      ghc-mod
      # xmonad xmonad-contrib xmonad-extras xmobar
      # haskintex
    ]);

    haskellPackages = super.haskellPackages.override {
      extension = self: super: {
        abcnotation = self.callPackage ./abcnotation.nix {};
        prettify = self.callPackage ./prettify.nix {};
      };
    };
  };
}</code></pre>
<p>Install the haskellEnv with</p>
<pre><code>$ nix-env -iA nixpkgs.haskellEnv</code></pre>
<h2 id="the-workflow">The workflow</h2>
<p>nix-shell</p>
<pre><code>nix-shell --pure</code></pre>
<p>This blocks out all other possible packages from the user environment and only uses the ones defined on a project basis (i.e. in the default.nix and shell.nix files in the current project folder).</p>
<p>Using</p>
<pre><code>cabal2nix --shell . &gt; shell.nix</code></pre>
<p>When running this the first time I had an error about the nixpkgs directory and had to source ~/.bashrc with the proper $NIX_PATH variable.</p>
<pre><code>nix-shell -I ~ --command 'cabal configure'</code></pre>
<p>I got an error message about a nonfree license. Looking more into it, it’s my project that’s the culprot: the hakyll cabal package isn’t declaring a license. Wow, never got a build tool tell me that before. But I guess it makes a whole lot of sense, and it led me to <a href="https://github.com/haskell/cabal/issues/847#issuecomment-87065077">ponder about</a> what license a website generator should have, is it content or is it code?</p>
<p>I only spent a very short amount of time using cabal, and it seems that with the latest version and <code>cabal sandbox</code> things improved significantly. Cabal sandboxes allow several version of libraries to co-exist. But the time it took for spinning up a sandbox for a large project is quite long and in the worst case scenario, when dependencies reach into packages that are in the Haskell distribution (like cabal itself) then things start to be quite difficult. What Nix promises is that everything is separated by default, and when it’s safe to share packages (same hash of the whole dependency tree) then they won’t be rebuilt, meaning less compilation when its not needed! Nix still offers ways to control dependencies in a very granular way (what seems to be called deep overrides).</p>
<p>Time to cabal build:</p>
<pre><code>cabal build</code></pre>
<p>Note that this should be doable from the user environment (i.e. without the nix-shell command) except that it fails with this error:</p>
<pre><code>ghc-7.8.4/include/Stg.h:65:10:
     fatal error: 'math.h' file not found
#include &lt;math.h&gt;</code></pre>
<p>Oops, seems like <a href="https://github.com/NixOS/nixpkgs/issues/6390">this thread</a> says that things don’t quite work the way it’s supposed to on OSX (because of the clang compiler). The option seems to be to rebuild everything with <code>export NIX_CFLAGS_COMPILE=&quot;-idirafter /usr/include&quot;</code>.</p>
<p>Instead I give a shot to running cabal (therefore ghc) from within the nix-shell and tada, it works:</p>
<pre><code>nix-shell -I ~ --command 'cabal build'
Building iilab-org-hakyll-0.1.0.0...
Preprocessing executable 'site' for iilab-org-hakyll-0.1.0.0...
[1 of 1] Compiling Main             ( site.hs, dist/build/site/site-tmp/Main.o)
Linking dist/build/site/site ...</code></pre>
<p>Although the problem is ugly (really? you can’t run ghc</p>
              								    <div id="disqus_thread"></div>

              </div><!-- /.sidemeta -->
            </div><!-- /.col -->            
          </div><!-- /.row -->
        </div><!-- /.container -->
      </section>
    </main>
		<footer class="dark-bg">
			<div class="container inner">
				<div class="row">
					
					<div class="col-md-3 col-sm-6 inner">
						<h4>Who we are</h4>
						<a href="index.html"><img class="logo img-intext" src="../images/logo-white.svg" alt></a>
						<p>We harness information innovation to help your social good initiatives improve their human impact.</p>
						<a href="../index.html#team" class="txt-btn">More about us</a>
					</div><!-- /.col -->
					
					<div class="col-md-3 col-sm-6 inner">
						<h4>Latest projects</h4>
						
						<div class="row thumbs gap-xs">
							
<script type="text/javascript">
    var disqus_shortname = 'iilab';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>


                <!-- JavaScripts placed at the end of the document so the pages load faster -->
        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u=(("https:" == document.location.protocol) ? "https" : "http") + "://stats.iilab.org/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', 1]);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
            g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="http://stats.iilab.org/piwik.php?idsite=1" style="border:0;" alt /></p></noscript>
        <script src="js/scripts.js"></script> 
        <!-- End Piwik Code 
        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/jquery.easing.1.3.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="/assets/js/bootstrap-hover-dropdown.min.js"></script>
        <script src="/assets/js/skrollr.min.js"></script>
        <script src="/assets/js/skrollr.stylesheets.min.js"></script>
        <script src="/assets/js/waypoints.min.js"></script>
        <script src="/assets/js/waypoints-sticky.min.js"></script>
        <script src="/assets/js/owl.carousel.min.js"></script>
        <script src="/assets/js/jquery.isotope.min.js"></script>
        <script src="/assets/js/jquery.easytabs.min.js"></script>
        <script src="/assets/js/jquery.slickforms.js"></script>
<!--        <script src="/assets/js/google.maps.api.v3.js"></script> 
        <script src="/assets/js/viewport-units-buggyfill.js"></script>
        <script src="/assets/js/scripts.js"></script>
        <script src="/assets/js/iilab.js"></script> -->
    </body>
</html>